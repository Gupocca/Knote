function DataClient(t,e,n){this.client=new Dropbox.Client({key:t}),this.authCallback=n,this.changeCallback=e,this.data=null,this.notepads=null,this.initialized=!1,this.authenticate(!1),this.client.isAuthenticated()&&this.initialize()}function Renderer(){this.writer=new stmd.HtmlRenderer,this.reader=new stmd.DocParser}var util={tagBody:"(?:[^\"'>]|\"[^\"]*\"|'[^']*')*",tagOrComment:new RegExp("<(?:!--(?:(?:-*[^->])*--+|-?)|script\\b"+this.tagBody+">[\\s\\S]*?</script\\s*|style\\b"+this.tagBody+">[\\s\\S]*?</style\\s*|/?[a-z]"+this.tagBody+")>","gi"),removeTags:function(t){"use strict";var e;do e=t,t=t.replace(this.tagOrComment,"");while(t!==e);return t.replace(/</g,"&lt;")},showError:function(t){$("#errors").css("display","block"),$("#alert").html("<strong>Error!</strong> "+t)},hideError:function(){$("#errors").css("display","none")},isEmptyOrSpaces:function(t){return null===t||null!==t.match(/^ *$/)}};String.prototype.endsWith=function(t){return-1!==this.indexOf(t,this.length-t.length)},String.prototype.charExists=function(t,e){return t>=0&&t<this.length&&this.charAt(t)===e},String.prototype.strip=function(){var t=document.createElement("div");return t.innerHTML=this,t.textContent||t.innerText||""},DataClient.prototype.authenticate=function(t){var e=this,n=0==arguments.length?!0:t;this.client.authenticate({interactive:n},function(t){e.authCallback(t,e.client.isAuthenticated())})},DataClient.prototype.initialize=function(){if(this.client.isAuthenticated()){var t=this,e=this.client.getDatastoreManager();e.openDefaultDatastore(function(e,n){e&&util.showError("Unable to access data."),t.data=n,t.notepads=t.data.getTable("notepads"),t.initialized=!0,t.changeCallback(t),t.addChangedListener(t.changeCallback)})}},DataClient.prototype.addChangedListener=function(t){var e=this;this.data.recordsChanged.addListener(function(){t(e)}),t(this)},DataClient.prototype.getPad=function(t){if(!this.initialized)return"";var e=this.notepads.query({padname:t});return e.length>0?e[0].get("data"):""},DataClient.prototype.setPad=function(t,e){if(!this.initialized)return"";var n=this.notepads.query({padname:t});n.length>0?n[0].set("data",e):this.notepads.insert({padname:t,data:e,exists:!0,created:new Date})},DataClient.prototype.createPad=function(t){util.isEmptyOrSpaces(t)||(this.padExists(t)?alert("notepad already exists"):this.setPad(t,""))},DataClient.prototype.getPadNames=function(){if(!this.initialized)return"";var t=this.notepads.query({exists:!0});return t.map(function(t){return t.get("padname")})},DataClient.prototype.padExists=function(t){if(!this.initialized)return"";var e=this.notepads.query({padname:t});return e.length>0},DataClient.prototype.deletePad=function(t){if(!this.initialized)return"";var e=this.notepads.query({padname:t});e.length>0&&e[0].deleteRecord()},Renderer.prototype.renderMath=function(t,e){return katex.renderToString(t.strip(),{displayMode:e})},Renderer.prototype.render=function(t){function e(){normalMathMode?(output+=_this.renderMath(segment,!1),normalMathMode=!1):centeredMathMode?(output+=_this.renderMath(segment,!0),centeredMathMode=!1):(output+=segment,centeredToken?centeredMathMode=!0:normalMathMode=!0)}for(t=util.removeTags(t),t=t.split("\\$").join("\\\\$"),t=this.writer.renderBlock(this.reader.parse(t)),index=-1,prevIndex=-1,normalMathMode=!1,centeredMathMode=!1,centeredToken=!1,output="",_this=this;-1!==(index=t.indexOf("$",index+1));)centeredToken=!1,t.charExists(index-1,"\\")||(t.charExists(index+1,"$")&&(centeredToken=centeredMathMode||!t.charExists(index+2,"$")||index+1===t.length-1),segment=t.slice(prevIndex+1,index),e(),centeredToken&&index++,prevIndex=index);return segment=t.slice(prevIndex+1),e(),output.split("\\$").join("$")};var defaultNotepad="default",currentNotepad=defaultNotepad,lastSave="";$(document).ready(function(){function t(){try{util.hideError();var t=$("#tex").val();lastSave=t,i.setPad(currentNotepad,t),$("#output").html(a.render(t))}catch(e){util.showError(e.message)}}function e(e){var a,i;currentNotepad===defaultNotepad&&(a=e.getPadNames(),a.length>0?currentNotepad=a[0]:$.get("defaultFile.md",function(t){e.setPad(defaultNotepad,t)})),$("#current-notepad").text(currentNotepad),i=e.getPad(currentNotepad),i!==$("#tex").val()&&i!=lastSave&&($("#tex").val(i),t()),n(e)}function n(t){var n=t.getPadNames(),a=n.map(function(t){var e=util.removeTags(t);return'<li><a class="swap-notepad" href="#" data-dismiss="modal">'+e+'</a><a class="remove-notepad" href="#" data-notepad="'+e+'"><i class="fa fa-times"></i></a></li>'}).join("");$("#notepad-selection").html("<ul>"+a+"</ul>"),$("#notepad-selection li a.swap-notepad").click(function(){return currentNotepad=$(this).text(),e(t),$("#notepadModal").modal("hide"),!1}),$("#notepad-selection li a.remove-notepad").click(function(){name=$(this).data("notepad");var n=confirm('Are you sure you want to delete notepad "'+name+'"?');return n&&(name===currentNotepad&&(currentNotepad=defaultNotepad),t.deletePad(name)),e(t),!1})}var a=new Renderer,i=new DataClient("7nj69doyzp49ge1",e,function(t,e){t?(util.showError("Unable to authenticate."),$("#dropbox-button").addClass("disabled")):e&&($("#dropbox").css("display","none"),$("#app").css("display","block"),$("#current-notepad").css("display","inline-block"))});$("#render").click(t),$("#tex").bind("keydown","ctrl+return",t),$("#dropbox-button").click(function(){i.authenticate(),i.initialize()}),$("#notepad-creation").submit(function(){var t=$("#new-notepad-name").val();return $("#new-notepad-name").val(""),i.createPad(t),n(i),!1})});
