function removeTags(e){var t;do t=e,e=e.replace(tagOrComment,"");while(e!==t);return e.replace(/</g,"&lt;")}var writer=new stmd.HtmlRenderer,reader=new stmd.DocParser,defaultNotepad="default",currentNotepad=defaultNotepad;$(document).ready(function(){function e(e){return null===e||null!==e.match(/^ *$/)}function t(e){var t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText||""}var n=function(){if(currentNotepad==defaultNotepad){var e=v();e.length>0?currentNotepad=e[0]:$.get("defaultFile.md",function(e){s(defaultNotepad,e)})}$("#current-notepad").text(currentNotepad);var t=p(currentNotepad);t!=$("#tex").val()&&($("#tex").val(p(currentNotepad)),b()),a()},a=function(){for(var e=v(),t="<ul>",a=0;a<e.length;a++){var r=removeTags(e[a]);t+='<li><a class="swap-notepad" href="#" data-dismiss="modal">'+r+'</a><a class="remove-notepad" href="#" data-notepad="'+r+'"><i class="fa fa-times"></i></a></li>'}t+="</ul>",$("#notepad-selection").html(t),$("#notepad-selection li a.swap-notepad").click(function(){return currentNotepad=$(this).text(),n(),$("#notepadModal").modal("hide"),!1}),$("#notepad-selection li a.remove-notepad").click(function(){var e=$(this).data("notepad"),t=confirm('Are you sure you want to delete notepad "'+e+'"?');return t&&(e==currentNotepad&&(currentNotepad=defaultNotepad),f(e)),n(),!1})},r=function(){var t=$("#new-notepad-name").val();$("#new-notepad-name").val(""),e(t)||(g(t)?alert("notepad already exists"):(s(t,""),a()))};$("#notepad-creation").submit(function(){return r(),!1});var o=function(e){$("#errors").css("display","block"),$("#alert").html("<strong>Error!</strong> "+e)},d=function(){$("#errors").css("display","none")},l=new Dropbox.Client({key:"7nj69doyzp49ge1"}),i=null;l.authenticate({interactive:!1},function(e){e&&(o("Unable to authenticate."),$("#dropbox-button").addClass("disabled"))});var u=function(){l.isAuthenticated()&&($("#dropbox").css("display","none"),$("#app").css("display","block"),$("#current-notepad").css("display","inline-block"))};u(),$("#dropbox-button").click(function(){l.authenticate({},function(e){e&&(o("Unable to authenticate."),$("#dropbox-button").addClass("disabled")),u()})});var c=function(){console.log("Channels");var e=l.getDatastoreManager();e.openDefaultDatastore(function(e,t){e&&o("Unable to access data."),i=t,t.recordsChanged.addListener(function(){n()}),n()})};c();var s=function(e,t){if(null!==i){var n=i.getTable("notepads"),a=n.query({padname:e});if(a.length>0){var r=a[0];r.set("data",t)}else{n.insert({padname:e,data:t,exists:!0,created:new Date})}}},p=function(e){if(null===i)return"";var t=i.getTable("notepads"),n=t.query({padname:e});return n.length>0?n[0].get("data"):""},f=function(e){if(null!==i){var t=i.getTable("notepads"),n=t.query({padname:e});n.length>0&&n[0].deleteRecord()}},g=function(e){if(null===i)return!1;var t=i.getTable("notepads"),n=t.query({padname:e});return n.length>0},v=function(){if(null===i)return"";var e=i.getTable("notepads"),t=e.query({exists:!0});if(t.length>0){for(var n=new Array,a=0;a<t.length;a++)n[a]=t[a].get("padname");return n}return""};String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)};var m=function(e){return katex.renderToString(t(e))},h=function(e){return'<div class="text-center">'+katex.renderToString("\\displaystyle {"+t(e)+"}")+"</div>"},y=function(e,t,n){return t>=0&&t<e.length&&e.charAt(t)==n},b=function(){d();var e=(document.getElementById("output"),$("#tex").val());s(currentNotepad,e),e=e.split("\\$").join("\\\\$"),e=writer.renderBlock(reader.parse(e));var t=-1,n=-1,a=!1,r=!1,l="";try{for(;-1!=(t=e.indexOf("$",t+1));)if(!y(e,t-1,"\\")){var i=!1;y(e,t+1,"$")&&(i=r||!y(e,t+2,"$")||t+1==e.length-1);var u=e.slice(n+1,t);a?(l+=m(u),a=!1):r?(l+=h(u),r=!1):(l+=u,i?r=!0:a=!0),i&&t++,n=t}var u=e.slice(n+1);l+=a?m(u):r?h(u):u,$("#output").html(l.split("\\$").join("$"))}catch(c){o(c.message)}};$("#tex").focus(),$("#render").click(b),$("#tex").bind("keydown","ctrl+return",b)});var tagBody="(?:[^\"'>]|\"[^\"]*\"|'[^']*')*",tagOrComment=new RegExp("<(?:!--(?:(?:-*[^->])*--+|-?)|script\\b"+tagBody+">[\\s\\S]*?</script\\s*|style\\b"+tagBody+">[\\s\\S]*?</style\\s*|/?[a-z]"+tagBody+")>","gi");