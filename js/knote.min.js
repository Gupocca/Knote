var writer=new stmd.HtmlRenderer,reader=new stmd.DocParser,defaultNotepad="default",currentNotepad=defaultNotepad,tagBody,tagOrComment,removeTags;$(document).ready(function(){"use strict";var e,t,n,a,r,o,d,l,i,c,s,u,p,f,g,m,h,v,y,b;e=new Dropbox.Client({key:"7nj69doyzp49ge1"}),t=null,n=function(){var e,n,a,r;if(null===t)return"";if(r=t.getTable("notepads"),a=r.query({exists:!0}),a.length>0){for(n=[],e=0;e<a.length;e++)n[e]=a[e].get("padname");return n}},a=function(){var e,t;currentNotepad===defaultNotepad&&(e=n(),e.length>0?currentNotepad=e[0]:$.get("defaultFile.md",function(e){u(defaultNotepad,e)})),$("#current-notepad").text(currentNotepad),t=p(currentNotepad),t!==$("#tex").val()&&($("#tex").val(p(currentNotepad)),b()),r()},r=function(){var e,t,r=n(),o="<ul>";for(t=0;t<r.length;t++)e=removeTags(r[t]),o+='<li><a class="swap-notepad" href="#" data-dismiss="modal">'+e+'</a><a class="remove-notepad" href="#" data-notepad="'+e+'"><i class="fa fa-times"></i></a></li>';o+="</ul>",$("#notepad-selection").html(o),$("#notepad-selection li a.swap-notepad").click(function(){return currentNotepad=$(this).text(),a(),$("#notepadModal").modal("hide"),!1}),$("#notepad-selection li a.remove-notepad").click(function(){e=$(this).data("notepad");var t=confirm('Are you sure you want to delete notepad "'+e+'"?');return t&&(e===currentNotepad&&(currentNotepad=defaultNotepad),f(e)),a(),!1})},o=function(e){return null===e||null!==e.match(/^ *$/)},d=function(){var e=$("#new-notepad-name").val();$("#new-notepad-name").val(""),o(e)||(g(e)?alert("notepad already exists"):(u(e,""),r()))},$("#notepad-creation").submit(function(){return d(),!1}),i=function(e){$("#errors").css("display","block"),$("#alert").html("<strong>Error!</strong> "+e)},c=function(){$("#errors").css("display","none")},e.authenticate({interactive:!1},function(e){e&&(i("Unable to authenticate."),$("#dropbox-button").addClass("disabled"))}),l=function(){e.isAuthenticated()&&($("#dropbox").css("display","none"),$("#app").css("display","block"),$("#current-notepad").css("display","inline-block"))},$("#dropbox-button").click(function(){e.authenticate({},function(e){e&&(i("Unable to authenticate."),$("#dropbox-button").addClass("disabled")),l()})}),s=function(){console.log("Channels");var n=e.getDatastoreManager();n.openDefaultDatastore(function(e,n){e&&i("Unable to access data."),t=n,n.recordsChanged.addListener(function(){a()}),a()})},u=function(e,n){var a,r,o;null!==t&&(a=t.getTable("notepads"),r=a.query({padname:e}),r.length>0?(o=r[0],o.set("data",n)):a.insert({padname:e,data:n,exists:!0,created:new Date}))},p=function(e){var n,a;return null===t?"":(n=t.getTable("notepads"),a=n.query({padname:e}),a.length>0?a[0].get("data"):"")},f=function(e){var n,a;null!==t&&(n=t.getTable("notepads"),a=n.query({padname:e}),a.length>0&&a[0].deleteRecord())},g=function(e){var n,a;return null===t?!1:(n=t.getTable("notepads"),a=n.query({padname:e}),a.length>0)},m=function(e){var t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText||""},String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)},h=function(e){return katex.renderToString(m(e))},v=function(e){return'<div class="text-center">'+katex.renderToString("\\displaystyle {"+m(e)+"}")+"</div>"},y=function(e,t,n){return t>=0&&t<e.length&&e.charAt(t)===n},b=function(){var e,t,n,a,r,o,d,l;c(),e=$("#tex").val(),u(currentNotepad,e),e=e.split("\\$").join("\\\\$"),e=writer.renderBlock(reader.parse(e)),t=-1,n=-1,a=!1,r=!1,o="";try{for(;-1!==(t=e.indexOf("$",t+1));)y(e,t-1,"\\")||(d=!1,y(e,t+1,"$")&&(d=r||!y(e,t+2,"$")||t+1===e.length-1),l=e.slice(n+1,t),a?(o+=h(l),a=!1):r?(o+=v(l),r=!1):(o+=l,d?r=!0:a=!0),d&&t++,n=t);l=e.slice(n+1),o+=a?h(l):r?v(l):l,$("#output").html(o.split("\\$").join("$"))}catch(s){i(s.message)}},l(),s(),$("#tex").focus(),$("#render").click(b),$("#tex").bind("keydown","ctrl+return",b)}),tagBody="(?:[^\"'>]|\"[^\"]*\"|'[^']*')*",tagOrComment=new RegExp("<(?:!--(?:(?:-*[^->])*--+|-?)|script\\b"+tagBody+">[\\s\\S]*?</script\\s*|style\\b"+tagBody+">[\\s\\S]*?</style\\s*|/?[a-z]"+tagBody+")>","gi"),removeTags=function(e){"use strict";var t;do t=e,e=e.replace(tagOrComment,"");while(e!==t);return e.replace(/</g,"&lt;")};